<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>🚀 RisuAI 셔틀</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-color: #f8f9fa; --text-color: #212529; --border-color: #dee2e6;
      --input-bg: #ffffff; --input-border: #ced4da; --header-bg: #ffffff;
      --section-bg: #ffffff; --key-color: #495057;
      --btn-bg: #e9ecef; --btn-hover-bg: #dee2e6;
      --accent-btn-bg: #339af0; --accent-btn-hover-bg: #1c7ed6;
    }
    body.dark {
      --bg-color: #121212; --text-color: #e9ecef; --border-color: #343a40;
      --input-bg: #212529; --input-border: #495057; --header-bg: #1c1c1c;
      --section-bg: #1e1e1e; --key-color: #adb5bd;
      --btn-bg: #343a40; --btn-hover-bg: #495057;
      --accent-btn-bg: #1c7ed6; --accent-btn-hover-bg: #1b6ec2;
    }
    body {
      font-family: "Pretendard", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0; padding: 20px;
      background-color: var(--bg-color); color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }
    h1 { text-align: center; }
    h3 { margin-top: 0; }
    .main-container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 1fr; gap: 30px; }
    .generator-section { background-color: var(--section-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; }
    .input-group { margin-bottom: 15px; }
    .input-group label { display: block; font-weight: 600; margin-bottom: 5px; }
    input[type="text"], textarea {
      width: 100%; box-sizing: border-box; padding: 10px; font-size: 1rem;
      border: 1px solid var(--input-border); border-radius: 8px;
      background-color: var(--input-bg); color: inherit; font-family: inherit;
    }
    textarea { resize: vertical; min-height: 100px; }
    .output-area { white-space: pre-wrap; word-break: break-all; background-color: var(--bg-color); padding: 15px; border-radius: 8px; min-height: 50px; }
    .controls { display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px; }
    button {
      border: none; padding: 10px 15px; border-radius: 8px; font-size: 0.9rem;
      font-weight: 600; cursor: pointer; transition: background-color 0.2s;
      background-color: var(--btn-bg); color: var(--text-color);
    }
    button:hover { background-color: var(--btn-hover-bg); }
    button.primary { background-color: var(--accent-btn-bg); color: #fff; }
    button.primary:hover { background-color: var(--accent-btn-hover-bg); }
    .header { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto 20px; }
    
    /* Custom Toggle Generator Styles */
    #toggle-list { list-style: none; padding: 0; }
    .toggle-item { display: grid; grid-template-columns: auto 1fr 1fr 1fr auto; gap: 10px; align-items: center; padding: 10px; border-radius: 8px; background-color: var(--bg-color); margin-bottom: 8px; }
    .toggle-item.divider { grid-template-columns: auto 1fr auto; }
    .drag-handle { cursor: grab; padding: 0 10px; font-size: 1.5rem; line-height: 1; color: var(--key-color); }
    .toggle-item.dragging { opacity: 0.5; background: var(--accent-btn-bg); }
    .emoji-picker-btn { position: relative; }
    .emoji-popup { display: none; position: absolute; bottom: 100%; left: 0; background: var(--section-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; z-index: 10; flex-wrap: wrap; gap: 5px; width: 200px; }
    .emoji-popup span { cursor: pointer; font-size: 1.5rem; padding: 5px; border-radius: 4px; }
    .emoji-popup span:hover { background: var(--btn-bg); }
    .input-with-emoji { display: flex; align-items: center; gap: 5px; }
  </style>
</head>
<body>
  <header class="header">
    <h1>🚀 RisuAI 셔틀</h1>
    <button id="toggleDarkBtn">🌗</button>
  </header>

  <div class="main-container">
    <!-- 프롬프트 구조 생성기 -->
    <section class="generator-section">
      <h3>#1. 프롬프트 구조 만들기</h3>
      <div class="input-group">
        <label for="prompt-toggle-name">토글명 (영어)</label>
        <input type="text" id="prompt-toggle-name" placeholder="e.g., gemini">
      </div>
      <div class="input-group">
        <label for="prompt-content">프롬프트 내용</label>
        <textarea id="prompt-content" placeholder="e.g., you are a genius"></textarea>
      </div>
      <div class="input-group">
        <label>결과</label>
        <div id="prompt-output" class="output-area"></div>
      </div>
      <div class="controls">
         <button onclick="copyToClipboard('prompt-output', this)">📋 복사</button>
      </div>
    </section>

    <!-- 커스텀 토글 생성기 -->
    <section class="generator-section">
      <h3>#2. 커스텀 토글 만들기</h3>
      <ul id="toggle-list"></ul>
      <div class="controls">
        <button onclick="addToggleItem('divider')">+ 구분선 추가</button>
        <button onclick="addToggleItem('toggle')" class="primary">+ 토글 추가</button>
      </div>
       <div class="input-group" style="margin-top: 20px;">
        <label>결과</label>
        <div id="custom-toggle-output" class="output-area"></div>
      </div>
       <div class="controls">
         <button onclick="loadCustomToggles()">📂 불러오기</button>
         <button onclick="saveCustomToggles()">💾 저장</button>
         <button onclick="copyToClipboard('custom-toggle-output', this)">📋 복사</button>
         <input type="file" id="toggleFileInput" accept=".txt" style="display: none;">
      </div>
    </section>
  </div>

<script>
const promptToggleName = document.getElementById('prompt-toggle-name');
const promptContent = document.getElementById('prompt-content');
const promptOutput = document.getElementById('prompt-output');
const toggleList = document.getElementById('toggle-list');
const customToggleOutput = document.getElementById('custom-toggle-output');
const toggleFileInput = document.getElementById('toggleFileInput');

let toggleItems = [];
let draggedItem = null;

// --- #1. Prompt Structure Generator ---
function updatePromptOutput() {
    const name = promptToggleName.value.trim();
    const content = promptContent.value;
    if (!name) {
        promptOutput.textContent = '';
        return;
    }
    promptOutput.textContent = `{{#if {{getglobalvar::toggle_${name}}}}}\n${content}\n{{/if}}`;
}

// --- #2. Custom Toggle Generator ---
function renderToggleList() {
    toggleList.innerHTML = '';
    toggleItems.forEach((item, index) => {
        const li = document.createElement('li');
        li.className = 'toggle-item';
        li.draggable = true;
        li.dataset.index = index;

        let content = `<span class="drag-handle">⠿</span>`;
        if (item.type === 'divider') {
            li.classList.add('divider');
            content += `<input type="text" value="${item.name}" oninput="updateToggleItem(${index}, 'name', this.value)" placeholder="구분선명">`;
        } else {
            content += `
                <input type="text" value="${item.name}" oninput="updateToggleItem(${index}, 'name', this.value)" placeholder="토글명">
                <div class="input-with-emoji">
                    <input type="text" value="${item.label}" oninput="updateToggleItem(${index}, 'label', this.value)" placeholder="토글 표기">
                    <div class="emoji-picker-btn">
                        <button onclick="toggleEmojiPicker(this)">💖</button>
                        <div class="emoji-popup">
                           ${['🥰','🙂','🥵','👍','👎','✅','❌','💡','⚠️','💬','💖','🔥','🚀','✨'].map(emoji => `<span onclick="insertEmoji(this, ${index})">${emoji}</span>`).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        content += `<button onclick="deleteToggleItem(${index})">🗑️</button>`;
        li.innerHTML = content;
        toggleList.appendChild(li);
    });
    addDragEvents();
    updateCustomToggleOutput();
    saveToLocalStorage();
}

function addToggleItem(type) {
    if (type === 'divider') {
        toggleItems.push({ type: 'divider', name: '' });
    } else {
        toggleItems.push({ type: 'toggle', name: '', label: '' });
    }
    renderToggleList();
}

function deleteToggleItem(index) {
    toggleItems.splice(index, 1);
    renderToggleList();
}

function updateToggleItem(index, key, value) {
    toggleItems[index][key] = value;
    updateCustomToggleOutput();
    saveToLocalStorage();
}

function toggleEmojiPicker(btn) {
    const popup = btn.nextElementSibling;
    popup.style.display = popup.style.display === 'flex' ? 'none' : 'flex';
}

function insertEmoji(emojiEl, index) {
    const emoji = emojiEl.textContent;
    const currentLabel = toggleItems[index].label || '';
    toggleItems[index].label = currentLabel + emoji;
    renderToggleList();
    const popup = emojiEl.parentElement;
    popup.style.display = 'none';
}


function updateCustomToggleOutput() {
    const output = toggleItems.map(item => {
        if (item.type === 'divider') {
            return `=${item.name || ''}=divider`;
        } else {
            return `${item.name || ''}=${item.label || ''}`;
        }
    }).join('\n');
    customToggleOutput.textContent = output;
}

function addDragEvents() {
    const items = toggleList.querySelectorAll('.toggle-item');
    items.forEach(item => {
        item.addEventListener('dragstart', () => {
            draggedItem = item;
            setTimeout(() => item.classList.add('dragging'), 0);
        });
        item.addEventListener('dragend', () => {
            draggedItem.classList.remove('dragging');
            draggedItem = null;
        });
        item.addEventListener('dragover', e => {
            e.preventDefault();
            const afterElement = getDragAfterElement(toggleList, e.clientY);
            if (afterElement == null) {
                toggleList.appendChild(draggedItem);
            } else {
                toggleList.insertBefore(draggedItem, afterElement);
            }
        });
        item.addEventListener('drop', () => {
            const newOrder = [...toggleList.querySelectorAll('.toggle-item')].map(li => toggleItems[li.dataset.index]);
            toggleItems = newOrder;
            renderToggleList();
        });
    });
}

function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.toggle-item:not(.dragging)')];
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function saveCustomToggles() {
    const content = customToggleOutput.textContent;
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'risuai_custom_toggles.txt';
    a.click();
    URL.revokeObjectURL(url);
}

function loadCustomToggles() {
    toggleFileInput.click();
}

toggleFileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (event) => {
        const lines = event.target.result.split('\n');
        toggleItems = lines.filter(l => l.trim()).map(line => {
            if (line.startsWith('=') && line.endsWith('=divider')) {
                return { type: 'divider', name: line.slice(1, -8) };
            } else {
                const parts = line.split('=');
                return { type: 'toggle', name: parts[0] || '', label: parts.slice(1).join('=') || '' };
            }
        });
        renderToggleList();
    };
    reader.readAsText(file);
    e.target.value = '';
});


// --- General ---
function copyToClipboard(elementId, btn) {
    const el = document.getElementById(elementId);
    if (!el.textContent.trim()) return;
    navigator.clipboard.writeText(el.textContent).then(() => {
        showFeedback(btn, '✅ 복사 완료!', true);
    }).catch(() => {
        showFeedback(btn, '❌ 실패', false);
    });
}

function showFeedback(btn, message, isSuccess) {
    const originalText = btn.innerHTML;
    btn.innerHTML = message;
    setTimeout(() => { btn.innerHTML = originalText; }, 1500);
}

function saveToLocalStorage() {
    localStorage.setItem('risu_toggle_items', JSON.stringify(toggleItems));
}

document.getElementById('toggleDarkBtn').addEventListener('click', () => {
    document.body.classList.toggle('dark');
    localStorage.setItem('risu_darkmode', document.body.classList.contains('dark'));
});

// --- Initial Load ---
window.onload = () => {
    if (localStorage.getItem('risu_darkmode') === 'true') {
        document.body.classList.add('dark');
    }
    const savedItems = localStorage.getItem('risu_toggle_items');
    if (savedItems) {
        toggleItems = JSON.parse(savedItems);
    }
    renderToggleList();
    updatePromptOutput();
};

promptToggleName.addEventListener('input', updatePromptOutput);
promptContent.addEventListener('input', updatePromptOutput);
</script>
</body>
</html>
